const tokiPonaDict = {
    "a": "(emphasis, emotion, confirmation)",
    "akesi": "lizard, reptile",
    "ala": "no, not, nothing, zero",
    "alasa": "to hunt, to gather\npre-verb: to try to",
    "ale": "all, everything, universe\n100 (number)",
    "ali": "all, everything, universe\n100 (number)",
    "anpa": "below, downward, humble\nverb: to bow down; to conquer",
    "ante": "different, other, changed\nverb: to change",
    "anu": "[A] anu [B] — or",
    "awen": "kept, safe, enduring\nverb: to stay, to protect\npre-verb: to continue",
    "e": "[subject] li [verb] e [object]",
    "en": "[subject] en [subject]",
    "epiku": "epic, awesome",
    "esun": "trade, exchange, market",
    "ijo": "thing, object, matter",
    "ike": "bad, evil, complex, unnecessary",
    "ilo": "tool, machine, device",
    "insa": "inside, center, stomach, between",
    "jaki": "dirty, disgusting, toxic, waste",
    "jan": "person, people, somebody",
    "jasima": "mirror, reflection, echo\nverb: to reflect, to reverse",
    "jelo": "yellow",
    "jo": "to have, to carry, to hold",
    "kala": "fish, sea creature",
    "kalama": "sound, noise\nverb: to make noise, to play (instrument)",
    "kama": "arrival, event, coming, future\npre-verb: to become, to manage to",
    "kasi": "plant, grass, herb, leaf",
    "ken": "ability, possibility\npre-verb: can, may",
    "kepeken": "verb: to use\nprep: using, with",
    "kijetesantakalu": "raccoon, musteloid",
    "kili": "fruit, vegetable, mushroom",
    "kin": "very, really, also",
    "kipisi": "to cut, to divide",
    "kiwen": "hard object, stone, metal, solid",
    "ko": "powder, clay, paste, semi-solid",
    "kokosila": "to not speak toki pona in a toki pona setting",
    "kon": "air, spirit, essence, invisible",
    "ku": "Sonja Lang's second book",
    "kule": "color, colorful\nverb: to paint",
    "kulupu": "group, community, society, nation",
    "kute": "ear, hearing\nverb: to listen, to hear, to obey",
    "la": "[context] la [sentence]",
    "lanpan": "to take, to seize, to steal",
    "lape": "sleep, rest",
    "laso": "blue, green",
    "lawa": "head, mind\nverb: to lead, to control, to rule",
    "leko": "square, block, stairs",
    "len": "cloth, clothes, fabric, layer of privacy",
    "lete": "cold, cool, raw, uncooked",
    "li": "[subject] li [verb/adjective]",
    "lili": "small, few, young\nverb: to shrink",
    "linja": "long flexible object, string, rope, hair",
    "lipu": "flat object, book, document, paper, website",
    "loje": "red",
    "lon": "real, true, existing\nprep: at, in, on",
    "luka": "hand, arm\n5 (number)",
    "lukin": "eye, vision\nverb: to look, to see, to read\npre-verb: to seek to",
    "lupa": "hole, door, window, orifice",
    "ma": "earth, land, territory, country, outdoors",
    "mama": "parent, ancestor, creator, caretaker",
    "mani": "money, large domesticated animal",
    "meli": "woman, female, wife",
    "meso": "middle, average, moderate",
    "mi": "I, me, we, us",
    "mije": "man, male, husband",
    "misikeke": "medicine, cure",
    "moku": "food\nverb: to eat, to drink, to swallow",
    "moli": "death, dead, dying\nverb: to kill",
    "monsi": "back, behind, rear",
    "monsuta": "fear, monster, scary",
    "mu": "(animal sound)",
    "mun": "moon, star, night sky object",
    "musi": "game, art, fun\nverb: to play, to amuse",
    "mute": "many, more, quantity\n20 (number)",
    "n": "hmm, um (thinking sound)",
    "namako": "spice, addition, extra",
    "nanpa": "number\n-th (ordinal marker)",
    "nasa": "weird, unusual, strange, drunk",
    "nasin": "path, road, way, method, custom",
    "nena": "hill, mountain, bump, nose, button",
    "ni": "this, that",
    "nimi": "word, name",
    "noka": "foot, leg, bottom, lower part",
    "o": "[name] o! — hey!\no [verb]! — (command)",
    "oko": "eye",
    "olin": "love, compassion, respect",
    "ona": "he, she, it, they",
    "open": "start, beginning\nverb: to open, to turn on\npre-verb: to begin",
    "pakala": "broken, damaged, mistake\nverb: to break, to mess up\n(also: curse word)",
    "pali": "work, labor\nverb: to make, to do",
    "palisa": "long solid object, stick, branch",
    "pan": "bread, grain, rice",
    "pana": "to give, to send, to emit, to release",
    "pi": "[head noun] pi [modifier group]",
    "pilin": "feeling, heart, touch\nverb: to feel, to think",
    "pimeja": "black, dark, shadow",
    "pini": "end, finished, past\nverb: to stop, to close\npre-verb: to stop doing",
    "pipi": "insect, bug",
    "poka": "side, hip, nearby",
    "poki": "box, container, bowl, cup",
    "pona": "good, simple, friendly\nverb: to fix, to improve",
    "pu": "the official toki pona book\nverb: to interact with it",
    "sama": "same, similar, sibling\nprep: as, like",
    "seli": "heat, warmth, fire, hot",
    "selo": "outer form, shell, skin, boundary",
    "seme": "what? which? (question word)",
    "sewi": "above, high, sky, god\ndivine, sacred",
    "sijelo": "body, physical form, torso",
    "sike": "circle, ball, cycle, round",
    "sin": "new, fresh, additional",
    "sina": "you, your",
    "sinpin": "face, front, wall",
    "sitelen": "symbol, image, writing\nverb: to write, to draw, to record",
    "soko": "mushroom, fungus",
    "sona": "knowledge, information\nverb: to know\npre-verb: to know how to",
    "soweli": "land mammal, animal",
    "su": "Sonja Lang's illustrated story books",
    "suli": "big, tall, great, important\nverb: to grow",
    "suno": "sun, light, brightness",
    "supa": "horizontal surface, table, floor",
    "suwi": "sweet, cute, adorable",
    "tan": "cause, reason, origin\nprep: from, because of",
    "taso": "only, just\n(sentence start): but, however",
    "tawa": "movement, moving\nverb: to move\nprep: to, for, towards",
    "telo": "water, liquid, fluid\nverb: to wash, to clean",
    "tenpo": "time, moment, occasion",
    "toki": "speech, language, conversation\nverb: to speak, to talk, to think",
    "tomo": "home, building, room, indoor space",
    "tonsi": "non-binary, trans, gender-nonconforming",
    "tu": "two\nverb: to divide",
    "unpa": "sex, sexual",
    "uta": "mouth, lips",
    "utala": "fight, battle, war\nverb: to fight, to challenge",
    "walo": "white, bright, light",
    "wan": "one, part\nverb: to unite, to marry",
    "waso": "bird, flying creature",
    "wawa": "strong, powerful, energetic",
    "weka": "absent, away, remote\nverb: to remove, to get rid of",
    "wile": "want, need, desire\npre-verb: to want to"
};

document.addEventListener("DOMContentLoaded", function () {
    const editor = document.getElementById("tp-input");
    const tooltip = document.getElementById("tp-tooltip");
    if (!editor || !tooltip) return;

    function getCaretCharOffset() {
        const sel = window.getSelection();
        if (!sel.rangeCount || !editor.contains(sel.anchorNode)) return 0;
        const range = sel.getRangeAt(0).cloneRange();
        range.collapse(true);
        const pre = document.createRange();
        pre.selectNodeContents(editor);
        pre.setEnd(range.startContainer, range.startOffset);
        const div = document.createElement("div");
        div.appendChild(pre.cloneContents());
        return div.innerText.length;
    }

    function setCaretCharOffset(offset) {
        const sel = window.getSelection();
        let charCount = 0;
        const range = document.createRange();

        function walk(node) {
            if (node.nodeType === 3) {
                const next = charCount + node.length;
                if (offset >= charCount && offset <= next) {
                    range.setStart(node, offset - charCount);
                    range.collapse(true);
                    return true;
                }
                charCount = next;
            } else if (node.nodeName === "BR") {
                if (offset === charCount) {
                    range.setStart(node.parentNode, Array.from(node.parentNode.childNodes).indexOf(node) + 1);
                    range.collapse(true);
                    return true;
                }
                charCount++;
            } else {
                for (let i = 0; i < node.childNodes.length; i++) {
                    if (walk(node.childNodes[i])) return true;
                }
            }
            return false;
        }

        if (!walk(editor)) {
            range.selectNodeContents(editor);
            range.collapse(false);
        }
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function getPlainText() {
        let text = "";
        function walk(node) {
            if (node.nodeType === 3) {
                text += node.textContent;
            } else if (node.nodeName === "BR") {
                text += "\n";
            } else if (node.nodeName === "DIV" && text.length > 0 && !text.endsWith("\n")) {
                text += "\n";
                for (const c of node.childNodes) walk(c);
                return;
            }
            for (const c of node.childNodes || []) walk(c);
        }
        walk(editor);
        return text;
    }

    function esc(s) {
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function buildHTML(text) {
        if (!text) return "";
        const lines = text.split("\n");
        let html = "";
        for (let i = 0; i < lines.length; i++) {
            if (i > 0) html += "<br>";
            const tokens = lines[i].split(/(\s+)/);
            for (let j = 0; j < tokens.length; j++) {
                const t = tokens[j];
                if (/^\s+$/.test(t)) {
                    html += esc(t);
                    continue;
                }
                const clean = t.toLowerCase().replace(/[^a-z]/g, "");
                if (clean && tokiPonaDict[clean]) {
                    html += '<span class="tp-word" data-word="' + clean + '">' + esc(t) + "</span>";
                } else {
                    html += esc(t);
                }
            }
        }
        return html;
    }

    let updating = false;

    editor.addEventListener("input", function () {
        if (updating) return;
        updating = true;
        tooltip.classList.remove("visible");
        const offset = getCaretCharOffset();
        const text = getPlainText();
        editor.innerHTML = buildHTML(text);
        setCaretCharOffset(offset);
        updating = false;
    });

    editor.addEventListener("paste", function (e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text/plain");
        document.execCommand("insertText", false, text);
    });

    editor.addEventListener("mouseover", function (e) {
        const w = e.target.closest(".tp-word");
        if (!w) return;
        const key = w.dataset.word;
        if (!tokiPonaDict[key]) return;
        tooltip.textContent = tokiPonaDict[key];
        tooltip.classList.add("visible");
        const rect = w.getBoundingClientRect();
        const parentRect = editor.closest("#tp-lookup").getBoundingClientRect();
        tooltip.style.left = (rect.left - parentRect.left) + "px";
        tooltip.style.top = (rect.bottom - parentRect.top + 6) + "px";
    });

    editor.addEventListener("mouseout", function (e) {
        const w = e.target.closest(".tp-word");
        if (w) tooltip.classList.remove("visible");
    });
});
